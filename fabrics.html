<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fabrics – Handmade By July</title>
    <meta
      name="description"
      content="See an overview of the types of fabrics July loves to sew with – gentle cottons, linens, and cozy textures."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&family=Work+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="shell">
        <a href="index.html" class="brand">
          <img
            src="./assets/logo.png"
            alt="Handmade By July logo – hand-painted sun"
            class="brand-logo"
          />
          <div class="brand-text">
            <span class="brand-title">HANDMADE BY JULY</span>
            <span class="brand-tagline">Sunny, soft, handmade pieces</span>
          </div>
        </a>
        <button class="nav-toggle" aria-label="Toggle navigation">
          <span></span><span></span>
        </button>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="products.html">Products</a>
          <a href="fabrics.html">Fabrics</a>
          <a href="request.html">Request a piece</a>
          <a href="index.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="section page-hero">
        <div class="shell">
          <header class="section-heading">
            <h1 class="page-title">Fabrics in my stash</h1>
            <p>
              Here is a small overview of the types of fabrics I love working
              with. When you message me, you can mention any fabric that catches
              your eye.
            </p>
          </header>

          <div class="grid fabrics-grid" data-fabrics-grid></div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="shell footer-inner">
        <p>Handmade By July ☀</p>
        <p class="footer-small">
          Handmade with love in New York, with lots of sun.
        </p>
      </div>
    </footer>

    <script src="./script.js"></script>
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js";

      const supabaseUrl = "https://bmzavdormblxxmzeoshi.supabase.co";
      const supabaseAnonKey = "sb_publishable_Wap_flAGqOBtAXZzvi9fYg_Xo96ktf5";
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      const storageBucket = "handmade-by-july";

      const grid = document.querySelector("[data-fabrics-grid]");

      const placeholderFabricImages = [
        "https://images.pexels.com/photos/3738080/pexels-photo-3738080.jpeg",
        "https://images.pexels.com/photos/3965553/pexels-photo-3965553.jpeg",
        "https://images.pexels.com/photos/3738083/pexels-photo-3738083.jpeg",
      ];

      let isAdmin = false;

      async function checkAdmin() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        isAdmin = !!user;
      }

      function ensureAdminIndicator() {
        if (document.querySelector("[data-admin-indicator]")) return;
        const headerShell = document.querySelector(".site-header .shell");
        if (!headerShell) return;

        const box = document.createElement("div");
        box.className = "admin-indicator";
        box.setAttribute("data-admin-indicator", "true");
        box.textContent = "Logged in as admin";

        const button = document.createElement("button");
        button.type = "button";
        button.textContent = "Log out";
        box.appendChild(button);

        button.addEventListener("click", async () => {
          await supabase.auth.signOut();
          window.location.reload();
        });

        headerShell.appendChild(box);
      }

      async function uploadImageAndSave(fabricId, file) {
        const ext = file.name.split(".").pop();
        const path = `fabrics/${fabricId}-${Date.now()}.${ext}`;

        const { error: uploadError } = await supabase.storage
          .from(storageBucket)
          .upload(path, file, { upsert: true });

        if (uploadError) {
          console.error(uploadError);
          throw new Error("Upload failed");
        }

        const {
          data: { publicUrl },
        } = supabase.storage.from(storageBucket).getPublicUrl(path);

        const { error: updateError } = await supabase
          .from("fabrics")
          .update({ image_url: publicUrl })
          .eq("id", fabricId);

        if (updateError) {
          console.error(updateError);
          throw new Error("Could not save image");
        }
      }

      async function loadFabrics() {
        if (!grid) return;
        grid.innerHTML = "";

        await checkAdmin();

        if (isAdmin) {
          ensureAdminIndicator();
        }

        const { data: fabrics, error } = await supabase
          .from("fabrics")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error loading fabrics", error);
          const message = document.createElement("p");
          message.textContent =
            "I could not load the fabrics right now. Please try again a bit later.";
          grid.appendChild(message);
          return;
        }

        if (!fabrics || fabrics.length === 0) {
          const message = document.createElement("p");
          message.textContent =
            "No fabrics are listed yet. Once I add them here, they will appear on this page.";
          grid.appendChild(message);
        } else {
          fabrics.forEach((fabric, index) => {
            const card = document.createElement("div");
            card.className = "fabric-card";

            const imageUrl =
              fabric.image_url ||
              placeholderFabricImages[index % placeholderFabricImages.length];
            if (imageUrl) {
              const img = document.createElement("img");
              img.src = imageUrl;
              img.alt = fabric.name || "Fabric";
              img.style.width = "100%";
              img.style.borderRadius = "10px";
              img.style.marginBottom = "8px";
              card.appendChild(img);
            }

            const title = document.createElement("h3");
            title.textContent = fabric.name;

            const description = document.createElement("p");
            description.textContent = fabric.description || "";

            const bestFor = document.createElement("p");
            bestFor.textContent = fabric.best_for || "";

            card.appendChild(title);
            card.appendChild(description);
            card.appendChild(bestFor);

            if (Array.isArray(fabric.tags) && fabric.tags.length > 0) {
              const list = document.createElement("ul");
              list.className = "pill-list";
              fabric.tags.forEach((tag) => {
                const li = document.createElement("li");
                li.textContent = tag;
                list.appendChild(li);
              });
              card.appendChild(list);
            }

            if (isAdmin) {
              const adminBox = document.createElement("div");
              adminBox.style.marginTop = "10px";
              adminBox.style.fontSize = "12px";

              const label = document.createElement("p");
              label.textContent = "Change photo (only visible to you):";
              adminBox.appendChild(label);

              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.marginBottom = "6px";
              adminBox.appendChild(fileInput);

              const button = document.createElement("button");
              button.type = "button";
              button.className = "btn ghost";
              button.textContent = "Upload new photo";
              adminBox.appendChild(button);

              const status = document.createElement("p");
              status.style.marginTop = "4px";
              status.style.fontSize = "11px";
              status.style.color = "var(--ink-soft)";
              adminBox.appendChild(status);

              button.addEventListener("click", async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                  status.textContent = "Please choose a file first.";
                  return;
                }
                const file = fileInput.files[0];
                status.textContent = "Uploading…";
                try {
                  await uploadImageAndSave(fabric.id, file);
                  status.textContent = "Saved. Reloading…";
                  await loadFabrics();
                } catch (err) {
                  status.textContent = "I could not save this image.";
                }
              });

              card.appendChild(adminBox);
            }

            grid.appendChild(card);
          });
        }

        if (isAdmin) {
          const addCard = document.createElement("article");
          addCard.className = "fabric-card";

          const title = document.createElement("h3");
          title.textContent = "Add a new fabric";
          addCard.appendChild(title);

          const nameInput = document.createElement("input");
          nameInput.placeholder = "Name";
          nameInput.style.marginBottom = "6px";
          nameInput.style.width = "100%";
          addCard.appendChild(nameInput);

          const descriptionInput = document.createElement("textarea");
          descriptionInput.placeholder = "Description";
          descriptionInput.rows = 2;
          descriptionInput.style.marginBottom = "6px";
          descriptionInput.style.width = "100%";
          addCard.appendChild(descriptionInput);

          const bestForInput = document.createElement("textarea");
          bestForInput.placeholder = "Best for";
          bestForInput.rows = 2;
          bestForInput.style.marginBottom = "6px";
          bestForInput.style.width = "100%";
          addCard.appendChild(bestForInput);

          const tagsInput = document.createElement("input");
          tagsInput.placeholder = "Tags (comma separated)";
          tagsInput.style.marginBottom = "8px";
          tagsInput.style.width = "100%";
          addCard.appendChild(tagsInput);

          const imageInput = document.createElement("input");
          imageInput.type = "file";
          imageInput.accept = "image/*";
          imageInput.style.marginBottom = "8px";
          imageInput.style.width = "100%";
          addCard.appendChild(imageInput);

          const saveButton = document.createElement("button");
          saveButton.type = "button";
          saveButton.className = "btn primary";
          saveButton.textContent = "Save fabric";
          addCard.appendChild(saveButton);

          const status = document.createElement("p");
          status.style.marginTop = "6px";
          status.style.fontSize = "11px";
          status.style.color = "var(--ink-soft)";
          addCard.appendChild(status);

          saveButton.addEventListener("click", async () => {
            const name = nameInput.value.trim();
            if (!name) {
              status.textContent = "Please add a name.";
              return;
            }
            status.textContent = "Saving…";

            const tagsRaw = tagsInput.value.trim();
            const tags = tagsRaw
              ? tagsRaw.split(",").map((t) => t.trim()).filter(Boolean)
              : [];

            const file =
              imageInput.files && imageInput.files.length > 0
                ? imageInput.files[0]
                : null;

            const { data: newFabric, error } = await supabase
              .from("fabrics")
              .insert([
                {
                  name,
                  description: descriptionInput.value.trim(),
                  best_for: bestForInput.value.trim(),
                  tags,
                },
              ])
              .select()
              .single();

            if (error || !newFabric) {
              console.error(error);
              status.textContent = "I could not save this fabric.";
              return;
            }

            if (file) {
              try {
                await uploadImageAndSave(newFabric.id, file);
              } catch (e) {
                console.error(e);
                status.textContent =
                  "Fabric saved, but I could not save this image.";
                await loadFabrics();
                return;
              }
            }

            nameInput.value = "";
            descriptionInput.value = "";
            bestForInput.value = "";
            tagsInput.value = "";
            imageInput.value = "";
            status.textContent = "Saved. Reloading…";
            await loadFabrics();
          });

          grid.appendChild(addCard);
        }
      }

      loadFabrics();
    </script>
  </body>
</html>


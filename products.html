<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Products – Handmade By July</title>
    <meta
      name="description"
      content="Browse the handmade products July can sew for you – cases, totes, scrunchies and home pieces."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&family=Work+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="shell">
        <a href="index.html" class="brand">
          <img
            src="./assets/logo.png"
            alt="Handmade By July logo – hand-painted sun"
            class="brand-logo"
          />
          <div class="brand-text">
            <span class="brand-title">HANDMADE BY JULY</span>
            <span class="brand-tagline">Sunny, soft, handmade pieces</span>
          </div>
        </a>
        <button class="nav-toggle" aria-label="Toggle navigation">
          <span></span><span></span>
        </button>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="products.html">Products</a>
          <a href="fabrics.html">Fabrics</a>
          <a href="index.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="section page-hero">
        <div class="shell">
          <header class="section-heading">
            <h1 class="page-title">Products I can sew for you</h1>
            <p>
              These are some of the pieces I love making. We can always adjust
              measurements, colors, and fabrics to match your device and style.
            </p>
          </header>

          <div class="grid cards" data-products-grid></div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="shell footer-inner">
        <p>Handmade By July ☀</p>
        <p class="footer-small">
          Handmade with love in New York, with lots of sun.
        </p>
      </div>
    </footer>

    <script src="./script.js"></script>
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js";

      const supabaseUrl = "https://bmzavdormblxxmzeoshi.supabase.co";
      const supabaseAnonKey = "sb_publishable_Wap_flAGqOBtAXZzvi9fYg_Xo96ktf5";
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      const storageBucket = "handmade-by-july";

      const grid = document.querySelector("[data-products-grid]");

      const placeholderProductImages = [
        "https://images.pexels.com/photos/3965545/pexels-photo-3965545.jpeg",
        "https://images.pexels.com/photos/3738087/pexels-photo-3738087.jpeg",
        "https://images.pexels.com/photos/3738081/pexels-photo-3738081.jpeg",
      ];

      let isAdmin = false;
      let fabricsList = [];
      let fabricsLoaded = false;

      async function checkAdmin() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        isAdmin = !!user;
      }

      async function loadFabricsForInterest() {
        if (fabricsLoaded) return fabricsList;
        const { data, error } = await supabase
          .from("fabrics")
          .select("id, name")
          .order("name", { ascending: true });
        if (error) {
          console.error("Error loading fabrics for interest form", error);
          fabricsList = [];
        } else {
          fabricsList = data || [];
        }
        fabricsLoaded = true;
        return fabricsList;
      }

      function ensureAdminIndicator() {
        if (document.querySelector("[data-admin-indicator]")) return;
        const headerShell = document.querySelector(".site-header .shell");
        if (!headerShell) return;

        const box = document.createElement("div");
        box.className = "admin-indicator";
        box.setAttribute("data-admin-indicator", "true");
        box.textContent = "Logged in as admin";

        const button = document.createElement("button");
        button.type = "button";
        button.textContent = "Log out";
        box.appendChild(button);

        button.addEventListener("click", async () => {
          await supabase.auth.signOut();
          window.location.reload();
        });

        headerShell.appendChild(box);
      }

      async function uploadImageAndSave(productId, file) {
        const ext = file.name.split(".").pop();
        const path = `products/${productId}-${Date.now()}.${ext}`;

        const { error: uploadError } = await supabase.storage
          .from(storageBucket)
          .upload(path, file, { upsert: true });

        if (uploadError) {
          console.error(uploadError);
          throw new Error("Upload failed");
        }

        const {
          data: { publicUrl },
        } = supabase.storage.from(storageBucket).getPublicUrl(path);

        const { error: updateError } = await supabase
          .from("products")
          .update({ image_url: publicUrl })
          .eq("id", productId);

        if (updateError) {
          console.error(updateError);
          throw new Error("Could not save image");
        }
      }

      async function loadProducts() {
        if (!grid) return;
        grid.innerHTML = "";

        await checkAdmin();

        if (isAdmin) {
          ensureAdminIndicator();
        }

        const { data: products, error } = await supabase
          .from("products")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error loading products", error);
          const message = document.createElement("p");
          message.textContent =
            "I could not load the products right now. Please try again a bit later.";
          grid.appendChild(message);
          return;
        }

        if (!products || products.length === 0) {
          const message = document.createElement("p");
          message.textContent =
            "No products are listed yet. Once I add them here, they will appear on this page.";
          grid.appendChild(message);
        } else {
          products.forEach((product, index) => {
            const article = document.createElement("article");
            article.className = "card";

            const imageUrl =
              product.image_url ||
              placeholderProductImages[index % placeholderProductImages.length];
            if (imageUrl) {
              const img = document.createElement("img");
              img.src = imageUrl;
              img.alt = product.name || "Product";
              img.className = "card-photo";
              article.appendChild(img);
            }

            const body = document.createElement("div");
            body.className = "card-body";

            const title = document.createElement("h3");
            title.textContent = product.name;
            body.appendChild(title);

            if (product.short_description) {
              const short = document.createElement("p");
              short.textContent = product.short_description;
              body.appendChild(short);
            }

            if (product.details) {
              const details = document.createElement("p");
              details.textContent = product.details;
              body.appendChild(details);
            }

            if (Array.isArray(product.tags) && product.tags.length > 0) {
              const list = document.createElement("ul");
              list.className = "pill-list";
              product.tags.forEach((tag) => {
                const li = document.createElement("li");
                li.textContent = tag;
                list.appendChild(li);
              });
              body.appendChild(list);
            }

            const interestBox = document.createElement("div");
            interestBox.style.marginTop = "10px";
            interestBox.style.fontSize = "12px";

            const interestButton = document.createElement("button");
            interestButton.type = "button";
            interestButton.className = "btn ghost";
            interestButton.textContent = "I'm interested in this piece";
            interestBox.appendChild(interestButton);

            const interestForm = document.createElement("div");
            interestForm.style.display = "none";
            interestForm.style.marginTop = "8px";
            interestForm.style.borderTop = "1px solid rgba(220, 185, 135, 0.5)";
            interestForm.style.paddingTop = "8px";

            const nameRow = document.createElement("div");
            nameRow.style.display = "flex";
            nameRow.style.gap = "6px";
            nameRow.style.marginBottom = "6px";

            const firstName = document.createElement("input");
            firstName.placeholder = "First name";
            firstName.style.flex = "1";
            const lastName = document.createElement("input");
            lastName.placeholder = "Last name";
            lastName.style.flex = "1";
            nameRow.appendChild(firstName);
            nameRow.appendChild(lastName);
            interestForm.appendChild(nameRow);

            const emailInput = document.createElement("input");
            emailInput.type = "email";
            emailInput.placeholder = "Email";
            emailInput.style.marginBottom = "6px";
            emailInput.style.width = "100%";
            interestForm.appendChild(emailInput);

            const fabricSelect = document.createElement("select");
            fabricSelect.style.marginBottom = "6px";
            fabricSelect.style.width = "100%";
            interestForm.appendChild(fabricSelect);

            const messageInput = document.createElement("textarea");
            messageInput.rows = 2;
            messageInput.placeholder =
              "Optional message (for example, colors you like)";
            messageInput.style.marginBottom = "6px";
            messageInput.style.width = "100%";
            interestForm.appendChild(messageInput);

            const sendButton = document.createElement("button");
            sendButton.type = "button";
            sendButton.className = "btn primary";
            sendButton.textContent = "Send my interest";
            interestForm.appendChild(sendButton);

            const interestStatus = document.createElement("p");
            interestStatus.style.marginTop = "6px";
            interestStatus.style.fontSize = "11px";
            interestStatus.style.color = "var(--ink-soft)";
            interestForm.appendChild(interestStatus);

            let interestInitialized = false;

            interestButton.addEventListener("click", async () => {
              if (!interestInitialized) {
                interestStatus.textContent = "";
                fabricSelect.innerHTML = "";
                const fabrics = await loadFabricsForInterest();
                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = fabrics.length
                  ? "Choose a fabric (optional)"
                  : "No fabrics listed yet";
                fabricSelect.appendChild(placeholder);
                fabrics.forEach((fabric) => {
                  const opt = document.createElement("option");
                  opt.value = fabric.id;
                  opt.textContent = fabric.name;
                  fabricSelect.appendChild(opt);
                });
                interestInitialized = true;
              }

              interestForm.style.display =
                interestForm.style.display === "none" ? "block" : "none";
            });

            sendButton.addEventListener("click", async () => {
              interestStatus.textContent = "";
              const first = firstName.value.trim();
              const last = lastName.value.trim();
              const email = emailInput.value.trim();

              if (!first || !last || !email) {
                interestStatus.textContent =
                  "Please add your name and email so I can reply.";
                return;
              }

              interestStatus.textContent = "Sending…";

              const { error } = await supabase
                .from("product_interest_requests")
                .insert([
                  {
                    product_id: product.id,
                    fabric_id: fabricSelect.value || null,
                    first_name: first,
                    last_name: last,
                    email,
                    message: messageInput.value.trim(),
                  },
                ]);

              if (error) {
                console.error(error);
                interestStatus.textContent =
                  "I could not send this interest right now. Please try again a bit later.";
                return;
              }

              firstName.value = "";
              lastName.value = "";
              emailInput.value = "";
              fabricSelect.value = "";
              messageInput.value = "";
              interestStatus.textContent =
                "Thank you. I received your message and will get back to you.";
            });

            interestBox.appendChild(interestForm);
            body.appendChild(interestBox);

            if (isAdmin) {
              const adminBox = document.createElement("div");
              adminBox.style.marginTop = "10px";
              adminBox.style.fontSize = "12px";

              const label = document.createElement("p");
              label.textContent = "Change photo (only visible to you):";
              adminBox.appendChild(label);

              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.marginBottom = "6px";
              adminBox.appendChild(fileInput);

              const button = document.createElement("button");
              button.type = "button";
              button.className = "btn ghost";
              button.textContent = "Upload new photo";
              adminBox.appendChild(button);

              const status = document.createElement("p");
              status.style.marginTop = "4px";
              status.style.fontSize = "11px";
              status.style.color = "var(--ink-soft)";
              adminBox.appendChild(status);

              button.addEventListener("click", async () => {
                if (!fileInput.files || fileInput.files.length === 0) {
                  status.textContent = "Please choose a file first.";
                  return;
                }
                const file = fileInput.files[0];
                status.textContent = "Uploading…";
                try {
                  await uploadImageAndSave(product.id, file);
                  status.textContent = "Saved. Reloading…";
                  await loadProducts();
                } catch (err) {
                  status.textContent = "I could not save this image.";
                }
              });

              body.appendChild(adminBox);
            }

            article.appendChild(body);
            grid.appendChild(article);
          });
        }

        if (isAdmin) {
          const addCard = document.createElement("article");
          addCard.className = "card";

          const body = document.createElement("div");
          body.className = "card-body";

          const title = document.createElement("h3");
          title.textContent = "Add a new product";
          body.appendChild(title);

          const nameInput = document.createElement("input");
          nameInput.placeholder = "Name";
          nameInput.style.marginBottom = "6px";
          nameInput.style.width = "100%";
          body.appendChild(nameInput);

          const shortInput = document.createElement("textarea");
          shortInput.placeholder = "Short description";
          shortInput.rows = 2;
          shortInput.style.marginBottom = "6px";
          shortInput.style.width = "100%";
          body.appendChild(shortInput);

          const detailsInput = document.createElement("textarea");
          detailsInput.placeholder = "Details";
          detailsInput.rows = 3;
          detailsInput.style.marginBottom = "6px";
          detailsInput.style.width = "100%";
          body.appendChild(detailsInput);

          const tagsInput = document.createElement("input");
          tagsInput.placeholder = "Tags (comma separated)";
          tagsInput.style.marginBottom = "8px";
          tagsInput.style.width = "100%";
          body.appendChild(tagsInput);

          const imageInput = document.createElement("input");
          imageInput.type = "file";
          imageInput.accept = "image/*";
          imageInput.style.marginBottom = "8px";
          imageInput.style.width = "100%";
          body.appendChild(imageInput);

          const saveButton = document.createElement("button");
          saveButton.type = "button";
          saveButton.className = "btn primary";
          saveButton.textContent = "Save product";
          body.appendChild(saveButton);

          const status = document.createElement("p");
          status.style.marginTop = "6px";
          status.style.fontSize = "11px";
          status.style.color = "var(--ink-soft)";
          body.appendChild(status);

          saveButton.addEventListener("click", async () => {
            const name = nameInput.value.trim();
            if (!name) {
              status.textContent = "Please add a name.";
              return;
            }
            status.textContent = "Saving…";

            const tagsRaw = tagsInput.value.trim();
            const tags = tagsRaw
              ? tagsRaw.split(",").map((t) => t.trim()).filter(Boolean)
              : [];

            const file =
              imageInput.files && imageInput.files.length > 0
                ? imageInput.files[0]
                : null;

            const { data: newProduct, error } = await supabase
              .from("products")
              .insert([
                {
                  name,
                  short_description: shortInput.value.trim(),
                  details: detailsInput.value.trim(),
                  tags,
                },
              ])
              .select()
              .single();

            if (error || !newProduct) {
              console.error(error);
              status.textContent = "I could not save this product.";
              return;
            }

            if (file) {
              try {
                await uploadImageAndSave(newProduct.id, file);
              } catch (e) {
                console.error(e);
                status.textContent =
                  "Product saved, but I could not save this image.";
                await loadProducts();
                return;
              }
            }

            nameInput.value = "";
            shortInput.value = "";
            detailsInput.value = "";
            tagsInput.value = "";
            imageInput.value = "";
            status.textContent = "Saved. Reloading…";
            await loadProducts();
          });

          addCard.appendChild(body);
          grid.appendChild(addCard);
        }
      }

      loadProducts();
    </script>
  </body>
</html>

